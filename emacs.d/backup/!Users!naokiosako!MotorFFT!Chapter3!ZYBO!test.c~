#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <errno.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <math.h>

#define FFTN 512

void FftCal(int *iW, int *oR, int *oI);
void TxtLoad(char *fn, int *iW);
void TxtSave(char *fn, int *iW);

int main(int argc, char *argv[]) {

  int InWave[FFTN];
  int RealSpec[FFTN];
  int ImagSpec[FFTN];
  char input_file[256];
  int i, tmp, maxReal=0, maxI=0;

  if (argc < 2) {
      fprintf(stderr, "1st arg must be input file name.\n");
      return -1;
  }

  strcpy(input_file, argv[1]);
  TxtLoad(input_file, InWave);

// for(i = 0; i < 100000; i++)  
        FftCal(InWave, RealSpec, ImagSpec);
	for(i=0; i<FFTN; i++){
	    if(abs(RealSpec[i])>maxReal){
	    	maxReal=RealSpec[i];
	    	maxI=i;
	    }
	    /* printf("%d\n", abs(RealSpec[i])); */
	}
	printf("%d, %d", maxI, maxReal);


        TxtSave("fft.txt", RealSpec);

//    printf( "%d bytes\n", sizeof(testint) );

  return 0;
}

void FftCal(int *iW, int *oR, int *oI)
{
        short N = FFTN; 
         short P; 
        short N_2 = N/2;
        short i,j,k,kp,m,h;
        long long w1, w2;
        long long s1,s2;
        int t1,t2;
        int fReal[FFTN], fImag[FFTN];
        int tri[FFTN];

        tri[	0	] =	524287	;
        tri[	1	] =	524248	;
        tri[	2	] =	524129	;
        tri[	3	] =	523932	;
        tri[	4	] =	523655	;
        tri[	5	] =	523300	;
        tri[	6	] =	522866	;
        tri[	7	] =	522354	;
        tri[	8	] =	521762	;
        tri[	9	] =	521092	;
        tri[	10	] =	520344	;
        tri[	11	] =	519517	;
        tri[	12	] =	518612	;
        tri[	13	] =	517629	;
        tri[	14	] =	516568	;
        tri[	15	] =	515429	;
        tri[	16	] =	514213	;
        tri[	17	] =	512919	;
        tri[	18	] =	511548	;
        tri[	19	] =	510100	;
        tri[	20	] =	508575	;
        tri[	21	] =	506973	;
        tri[	22	] =	505295	;
        tri[	23	] =	503541	;
        tri[	24	] =	501711	;
        tri[	25	] =	499806	;
        tri[	26	] =	497825	;
        tri[	27	] =	495770	;
        tri[	28	] =	493639	;
        tri[	29	] =	491435	;
        tri[	30	] =	489156	;
        tri[	31	] =	486804	;
        tri[	32	] =	484378	;
        tri[	33	] =	481879	;
        tri[	34	] =	479308	;
        tri[	35	] =	476665	;
        tri[	36	] =	473950	;
        tri[	37	] =	471163	;
        tri[	38	] =	468306	;
        tri[	39	] =	465378	;
        tri[	40	] =	462380	;
        tri[	41	] =	459312	;
        tri[	42	] =	456175	;
        tri[	43	] =	452970	;
        tri[	44	] =	449696	;
        tri[	45	] =	446354	;
        tri[	46	] =	442946	;
        tri[	47	] =	439470	;
        tri[	48	] =	435929	;
        tri[	49	] =	432321	;
        tri[	50	] =	428649	;
        tri[	51	] =	424912	;
        tri[	52	] =	421111	;
        tri[	53	] =	417247	;
        tri[	54	] =	413320	;
        tri[	55	] =	409330	;
        tri[	56	] =	405279	;
        tri[	57	] =	401167	;
        tri[	58	] =	396995	;
        tri[	59	] =	392762	;
        tri[	60	] =	388471	;
        tri[	61	] =	384121	;
        tri[	62	] =	379713	;
        tri[	63	] =	375248	;
        tri[	64	] =	370727	;
        tri[	65	] =	366149	;
        tri[	66	] =	361517	;
        tri[	67	] =	356830	;
        tri[	68	] =	352089	;
        tri[	69	] =	347296	;
        tri[	70	] =	342450	;
        tri[	71	] =	337552	;
        tri[	72	] =	332604	;
        tri[	73	] =	327605	;
        tri[	74	] =	322558	;
        tri[	75	] =	317461	;
        tri[	76	] =	312317	;
        tri[	77	] =	307126	;
        tri[	78	] =	301888	;
        tri[	79	] =	296605	;
        tri[	80	] =	291278	;
        tri[	81	] =	285906	;
        tri[	82	] =	280492	;
        tri[	83	] =	275035	;
        tri[	84	] =	269537	;
        tri[	85	] =	263998	;
        tri[	86	] =	258420	;
        tri[	87	] =	252802	;
        tri[	88	] =	247147	;
        tri[	89	] =	241454	;
        tri[	90	] =	235725	;
        tri[	91	] =	229960	;
        tri[	92	] =	224161	;
        tri[	93	] =	218328	;
        tri[	94	] =	212462	;
        tri[	95	] =	206564	;
        tri[	96	] =	200635	;
        tri[	97	] =	194676	;
        tri[	98	] =	188688	;
        tri[	99	] =	182671	;
        tri[	100	] =	176626	;
        tri[	101	] =	170555	;
        tri[	102	] =	164459	;
        tri[	103	] =	158337	;
        tri[	104	] =	152192	;
        tri[	105	] =	146024	;
        tri[	106	] =	139833	;
        tri[	107	] =	133622	;
        tri[	108	] =	127391	;
        tri[	109	] =	121140	;
        tri[	110	] =	114871	;
        tri[	111	] =	108585	;
        tri[	112	] =	102283	;
        tri[	113	] =	95965	;
        tri[	114	] =	89632	;
        tri[	115	] =	83286	;
        tri[	116	] =	76928	;
        tri[	117	] =	70558	;
        tri[	118	] =	64177	;
        tri[	119	] =	57787	;
        tri[	120	] =	51388	;
        tri[	121	] =	44982	;
        tri[	122	] =	38568	;
        tri[	123	] =	32149	;
        tri[	124	] =	25725	;
        tri[	125	] =	19297	;
        tri[	126	] =	12866	;
        tri[	127	] =	6433	;
        tri[	128	] =	0	;
        tri[	129	] =	-6434	;
        tri[	130	] =	-12867	;
        tri[	131	] =	-19298	;
        tri[	132	] =	-25726	;
        tri[	133	] =	-32150	;
        tri[	134	] =	-38569	;
        tri[	135	] =	-44983	;
        tri[	136	] =	-51389	;
        tri[	137	] =	-57788	;
        tri[	138	] =	-64178	;
        tri[	139	] =	-70559	;
        tri[	140	] =	-76929	;
        tri[	141	] =	-83287	;
        tri[	142	] =	-89633	;
        tri[	143	] =	-95966	;
        tri[	144	] =	-102284	;
        tri[	145	] =	-108586	;
        tri[	146	] =	-114872	;
        tri[	147	] =	-121141	;
        tri[	148	] =	-127392	;
        tri[	149	] =	-133623	;
        tri[	150	] =	-139834	;
        tri[	151	] =	-146025	;
        tri[	152	] =	-152193	;
        tri[	153	] =	-158338	;
        tri[	154	] =	-164460	;
        tri[	155	] =	-170556	;
        tri[	156	] =	-176627	;
        tri[	157	] =	-182672	;
        tri[	158	] =	-188689	;
        tri[	159	] =	-194677	;
        tri[	160	] =	-200636	;
        tri[	161	] =	-206565	;
        tri[	162	] =	-212463	;
        tri[	163	] =	-218329	;
        tri[	164	] =	-224162	;
        tri[	165	] =	-229961	;
        tri[	166	] =	-235726	;
        tri[	167	] =	-241455	;
        tri[	168	] =	-247148	;
        tri[	169	] =	-252803	;
        tri[	170	] =	-258421	;
        tri[	171	] =	-263999	;
        tri[	172	] =	-269538	;
        tri[	173	] =	-275036	;
        tri[	174	] =	-280493	;
        tri[	175	] =	-285907	;
        tri[	176	] =	-291279	;
        tri[	177	] =	-296606	;
        tri[	178	] =	-301889	;
        tri[	179	] =	-307127	;
        tri[	180	] =	-312318	;
        tri[	181	] =	-317462	;
        tri[	182	] =	-322559	;
        tri[	183	] =	-327606	;
        tri[	184	] =	-332605	;
        tri[	185	] =	-337553	;
        tri[	186	] =	-342451	;
        tri[	187	] =	-347297	;
        tri[	188	] =	-352090	;
        tri[	189	] =	-356831	;
        tri[	190	] =	-361518	;
        tri[	191	] =	-366150	;
        tri[	192	] =	-370728	;
        tri[	193	] =	-375249	;
        tri[	194	] =	-379714	;
        tri[	195	] =	-384122	;
        tri[	196	] =	-388472	;
        tri[	197	] =	-392763	;
        tri[	198	] =	-396996	;
        tri[	199	] =	-401168	;
        tri[	200	] =	-405280	;
        tri[	201	] =	-409331	;
        tri[	202	] =	-413321	;
        tri[	203	] =	-417248	;
        tri[	204	] =	-421112	;
        tri[	205	] =	-424913	;
        tri[	206	] =	-428650	;
        tri[	207	] =	-432322	;
        tri[	208	] =	-435930	;
        tri[	209	] =	-439471	;
        tri[	210	] =	-442947	;
        tri[	211	] =	-446355	;
        tri[	212	] =	-449697	;
        tri[	213	] =	-452971	;
        tri[	214	] =	-456176	;
        tri[	215	] =	-459313	;
        tri[	216	] =	-462381	;
        tri[	217	] =	-465379	;
        tri[	218	] =	-468307	;
        tri[	219	] =	-471164	;
        tri[	220	] =	-473951	;
        tri[	221	] =	-476666	;
        tri[	222	] =	-479309	;
        tri[	223	] =	-481880	;
        tri[	224	] =	-484379	;
        tri[	225	] =	-486805	;
        tri[	226	] =	-489157	;
        tri[	227	] =	-491436	;
        tri[	228	] =	-493640	;
        tri[	229	] =	-495771	;
        tri[	230	] =	-497826	;
        tri[	231	] =	-499807	;
        tri[	232	] =	-501712	;
        tri[	233	] =	-503542	;
        tri[	234	] =	-505296	;
        tri[	235	] =	-506974	;
        tri[	236	] =	-508576	;
        tri[	237	] =	-510101	;
        tri[	238	] =	-511549	;
        tri[	239	] =	-512920	;
        tri[	240	] =	-514214	;
        tri[	241	] =	-515430	;
        tri[	242	] =	-516569	;
        tri[	243	] =	-517630	;
        tri[	244	] =	-518613	;
        tri[	245	] =	-519518	;
        tri[	246	] =	-520345	;
        tri[	247	] =	-521093	;
        tri[	248	] =	-521763	;
        tri[	249	] =	-522355	;
        tri[	250	] =	-522867	;
        tri[	251	] =	-523301	;
        tri[	252	] =	-523656	;
        tri[	253	] =	-523933	;
        tri[	254	] =	-524130	;
        tri[	255	] =	-524249	;
        tri[	256	] =	0	;
        tri[	257	] =	-6434	;
        tri[	258	] =	-12867	;
        tri[	259	] =	-19298	;
        tri[	260	] =	-25726	;
        tri[	261	] =	-32150	;
        tri[	262	] =	-38569	;
        tri[	263	] =	-44983	;
        tri[	264	] =	-51389	;
        tri[	265	] =	-57788	;
        tri[	266	] =	-64178	;
        tri[	267	] =	-70559	;
        tri[	268	] =	-76929	;
        tri[	269	] =	-83287	;
        tri[	270	] =	-89633	;
        tri[	271	] =	-95966	;
        tri[	272	] =	-102284	;
        tri[	273	] =	-108586	;
        tri[	274	] =	-114872	;
        tri[	275	] =	-121141	;
        tri[	276	] =	-127392	;
        tri[	277	] =	-133623	;
        tri[	278	] =	-139834	;
        tri[	279	] =	-146025	;
        tri[	280	] =	-152193	;
        tri[	281	] =	-158338	;
        tri[	282	] =	-164460	;
        tri[	283	] =	-170556	;
        tri[	284	] =	-176627	;
        tri[	285	] =	-182672	;
        tri[	286	] =	-188689	;
        tri[	287	] =	-194677	;
        tri[	288	] =	-200636	;
        tri[	289	] =	-206565	;
        tri[	290	] =	-212463	;
        tri[	291	] =	-218329	;
        tri[	292	] =	-224162	;
        tri[	293	] =	-229961	;
        tri[	294	] =	-235726	;
        tri[	295	] =	-241455	;
        tri[	296	] =	-247148	;
        tri[	297	] =	-252803	;
        tri[	298	] =	-258421	;
        tri[	299	] =	-263999	;
        tri[	300	] =	-269538	;
        tri[	301	] =	-275036	;
        tri[	302	] =	-280493	;
        tri[	303	] =	-285907	;
        tri[	304	] =	-291279	;
        tri[	305	] =	-296606	;
        tri[	306	] =	-301889	;
        tri[	307	] =	-307127	;
        tri[	308	] =	-312318	;
        tri[	309	] =	-317462	;
        tri[	310	] =	-322559	;
        tri[	311	] =	-327606	;
        tri[	312	] =	-332605	;
        tri[	313	] =	-337553	;
        tri[	314	] =	-342451	;
        tri[	315	] =	-347297	;
        tri[	316	] =	-352090	;
        tri[	317	] =	-356831	;
        tri[	318	] =	-361518	;
        tri[	319	] =	-366150	;
        tri[	320	] =	-370728	;
        tri[	321	] =	-375249	;
        tri[	322	] =	-379714	;
        tri[	323	] =	-384122	;
        tri[	324	] =	-388472	;
        tri[	325	] =	-392763	;
        tri[	326	] =	-396996	;
        tri[	327	] =	-401168	;
        tri[	328	] =	-405280	;
        tri[	329	] =	-409331	;
        tri[	330	] =	-413321	;
        tri[	331	] =	-417248	;
        tri[	332	] =	-421112	;
        tri[	333	] =	-424913	;
        tri[	334	] =	-428650	;
        tri[	335	] =	-432322	;
        tri[	336	] =	-435930	;
        tri[	337	] =	-439471	;
        tri[	338	] =	-442947	;
        tri[	339	] =	-446355	;
        tri[	340	] =	-449697	;
        tri[	341	] =	-452971	;
        tri[	342	] =	-456176	;
        tri[	343	] =	-459313	;
        tri[	344	] =	-462381	;
        tri[	345	] =	-465379	;
        tri[	346	] =	-468307	;
        tri[	347	] =	-471164	;
        tri[	348	] =	-473951	;
        tri[	349	] =	-476666	;
        tri[	350	] =	-479309	;
        tri[	351	] =	-481880	;
        tri[	352	] =	-484379	;
        tri[	353	] =	-486805	;
        tri[	354	] =	-489157	;
        tri[	355	] =	-491436	;
        tri[	356	] =	-493640	;
        tri[	357	] =	-495771	;
        tri[	358	] =	-497826	;
        tri[	359	] =	-499807	;
        tri[	360	] =	-501712	;
        tri[	361	] =	-503542	;
        tri[	362	] =	-505296	;
        tri[	363	] =	-506974	;
        tri[	364	] =	-508576	;
        tri[	365	] =	-510101	;
        tri[	366	] =	-511549	;
        tri[	367	] =	-512920	;
        tri[	368	] =	-514214	;
        tri[	369	] =	-515430	;
        tri[	370	] =	-516569	;
        tri[	371	] =	-517630	;
        tri[	372	] =	-518613	;
        tri[	373	] =	-519518	;
        tri[	374	] =	-520345	;
        tri[	375	] =	-521093	;
        tri[	376	] =	-521763	;
        tri[	377	] =	-522355	;
        tri[	378	] =	-522867	;
        tri[	379	] =	-523301	;
        tri[	380	] =	-523656	;
        tri[	381	] =	-523933	;
        tri[	382	] =	-524130	;
        tri[	383	] =	-524249	;
        tri[	384	] =	-524288	;
        tri[	385	] =	-524249	;
        tri[	386	] =	-524130	;
        tri[	387	] =	-523933	;
        tri[	388	] =	-523656	;
        tri[	389	] =	-523301	;
        tri[	390	] =	-522867	;
        tri[	391	] =	-522355	;
        tri[	392	] =	-521763	;
        tri[	393	] =	-521093	;
        tri[	394	] =	-520345	;
        tri[	395	] =	-519518	;
        tri[	396	] =	-518613	;
        tri[	397	] =	-517630	;
        tri[	398	] =	-516569	;
        tri[	399	] =	-515430	;
        tri[	400	] =	-514214	;
        tri[	401	] =	-512920	;
        tri[	402	] =	-511549	;
        tri[	403	] =	-510101	;
        tri[	404	] =	-508576	;
        tri[	405	] =	-506974	;
        tri[	406	] =	-505296	;
        tri[	407	] =	-503542	;
        tri[	408	] =	-501712	;
        tri[	409	] =	-499807	;
        tri[	410	] =	-497826	;
        tri[	411	] =	-495771	;
        tri[	412	] =	-493640	;
        tri[	413	] =	-491436	;
        tri[	414	] =	-489157	;
        tri[	415	] =	-486805	;
        tri[	416	] =	-484379	;
        tri[	417	] =	-481880	;
        tri[	418	] =	-479309	;
        tri[	419	] =	-476666	;
        tri[	420	] =	-473951	;
        tri[	421	] =	-471164	;
        tri[	422	] =	-468307	;
        tri[	423	] =	-465379	;
        tri[	424	] =	-462381	;
        tri[	425	] =	-459313	;
        tri[	426	] =	-456176	;
        tri[	427	] =	-452971	;
        tri[	428	] =	-449697	;
        tri[	429	] =	-446355	;
        tri[	430	] =	-442947	;
        tri[	431	] =	-439471	;
        tri[	432	] =	-435930	;
        tri[	433	] =	-432322	;
        tri[	434	] =	-428650	;
        tri[	435	] =	-424913	;
        tri[	436	] =	-421112	;
        tri[	437	] =	-417248	;
        tri[	438	] =	-413321	;
        tri[	439	] =	-409331	;
        tri[	440	] =	-405280	;
        tri[	441	] =	-401168	;
        tri[	442	] =	-396996	;
        tri[	443	] =	-392763	;
        tri[	444	] =	-388472	;
        tri[	445	] =	-384122	;
        tri[	446	] =	-379714	;
        tri[	447	] =	-375249	;
        tri[	448	] =	-370728	;
        tri[	449	] =	-366150	;
        tri[	450	] =	-361518	;
        tri[	451	] =	-356831	;
        tri[	452	] =	-352090	;
        tri[	453	] =	-347297	;
        tri[	454	] =	-342451	;
        tri[	455	] =	-337553	;
        tri[	456	] =	-332605	;
        tri[	457	] =	-327606	;
        tri[	458	] =	-322559	;
        tri[	459	] =	-317462	;
        tri[	460	] =	-312318	;
        tri[	461	] =	-307127	;
        tri[	462	] =	-301889	;
        tri[	463	] =	-296606	;
        tri[	464	] =	-291279	;
        tri[	465	] =	-285907	;
        tri[	466	] =	-280493	;
        tri[	467	] =	-275036	;
        tri[	468	] =	-269538	;
        tri[	469	] =	-263999	;
        tri[	470	] =	-258421	;
        tri[	471	] =	-252803	;
        tri[	472	] =	-247148	;
        tri[	473	] =	-241455	;
        tri[	474	] =	-235726	;
        tri[	475	] =	-229961	;
        tri[	476	] =	-224162	;
        tri[	477	] =	-218329	;
        tri[	478	] =	-212463	;
        tri[	479	] =	-206565	;
        tri[	480	] =	-200636	;
        tri[	481	] =	-194677	;
        tri[	482	] =	-188689	;
        tri[	483	] =	-182672	;
        tri[	484	] =	-176627	;
        tri[	485	] =	-170556	;
        tri[	486	] =	-164460	;
        tri[	487	] =	-158338	;
        tri[	488	] =	-152193	;
        tri[	489	] =	-146025	;
        tri[	490	] =	-139834	;
        tri[	491	] =	-133623	;
        tri[	492	] =	-127392	;
        tri[	493	] =	-121141	;
        tri[	494	] =	-114872	;
        tri[	495	] =	-108586	;
        tri[	496	] =	-102284	;
        tri[	497	] =	-95966	;
        tri[	498	] =	-89633	;
        tri[	499	] =	-83287	;
        tri[	500	] =	-76929	;
        tri[	501	] =	-70559	;
        tri[	502	] =	-64178	;
        tri[	503	] =	-57788	;
        tri[	504	] =	-51389	;
        tri[	505	] =	-44983	;
        tri[	506	] =	-38569	;
        tri[	507	] =	-32150	;
        tri[	508	] =	-25726	;
        tri[	509	] =	-19298	;
        tri[	510	] =	-12867	;
        tri[	511	] =	-6434	;

        i = N; P = 0;
        while (i != 1) {
                i = i / 2;
                P++;
        }

        for (i = 0; i < N; i++) {
                fReal[i] = iW[i]; fImag[i] = 0;
        }

        j = 0;
        for ( i = 0; i <= N-2; i++ ) {
                if (i < j) {
                        t1 = fReal[j]; fReal[j] = fReal[i]; fReal[i] = t1;
                }
                k = N_2;
                while (k <= j) {
                        j = j - k; k = k/2;
                }
                j = j + k;
        }

        for ( i = 1; i <= P; i++ ) {
                m = pow(2, i);
                h = m/2;
                for ( j = 0; j < h; j++ ) {
                        w1 = tri[j*(N/m)];
                        w2 = tri[j*(N/m) + N_2];
                        for( k = j; k < N; k+=m ) {
                                kp = k + h;
                                s1 = fReal[kp] * w1 - fImag[kp] * w2;
                                s2 = fReal[kp] * w2 + fImag[kp] * w1;
				s1 = s1 >> 19; s2 = s2 >> 19;

                                t1 = fReal[k] + s1; fReal[kp] = fReal[k] - s1; fReal[k] = t1;
                                t2 = fImag[k] + s2; fImag[kp] = fImag[k] - s2; fImag[k] = t2;
                        }
                }
        }
        for ( i = 0; i < N; i++ ) {
                oR[i] = fReal[i];
                oI[i] = fImag[i];
    //            oP[i] = fReal[i] * fReal[i] + fImag[i] * fImag[i];
    //            printf( "%d\n", oR[i] );
        }
}

void TxtLoad(char *fn, int *iW)
{
  int count = 0;
  char charline[40];
  FILE *fp;

  fp = fopen( fn, "r" );
  if( fp == NULL ){
    printf( "%s cannot be opened.\n", fn );
    exit(1);
  } 

  fseek( fp, 0L, SEEK_SET );
  while( fgets(charline, 40, fp) != NULL ) {
    iW[count] = atoi(charline);
//    printf( "%d  %d\n", count, iW[count] );
    count++;

    if(count == FFTN) {
      break;
    }
  } 
  fclose( fp );
}

void TxtSave(char *fn, int *iW)
{
  int i;
  char charline[40];
  FILE *fp;

  fp = fopen( fn, "w" );
  if( fp == NULL ){
    printf( "%s cannot be opened.\n", fn );
    exit(1);
  } 

  fseek( fp, 0L, SEEK_SET );
  for( i = 0; i < FFTN; i++) {
    sprintf(charline, "%d\n", iW[i]);
    fputs(charline, fp);
//    printf( "%d\n", iW[i] );
  } 
  fclose( fp );
}

